<VirtualHost *:80>
    ServerName registrar.test
    Redirect / https://registrar.test/
</VirtualHost>

<VirtualHost *:443>
    ServerName registrar.test
    SSLEngine on
    SSLProtocol all -SSLv2 -SSLv3
    SSLHonorCipherOrder on
    SSLCipherSuite "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA RC4 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS"
    SSLCertificateFile /opt/ca/certs/apache.crt
    SSLCertificateKeyFile /opt/ca/private/apache.key

    RequestHeader set X_FORWARDED_PROTO 'https'
    SSLProxyEngine on
    SSLCompression off

    RewriteEngine on

    <Proxy *>
        RedirectMatch ^/$ /registrar
        RedirectMatch ^/login$ /registrar/login
    </Proxy>

    SSLVerifyClient none
    SSLVerifyDepth 1

    SSLCACertificateFile /opt/ca/certs/ca.crt.pem
    SSLCARevocationPath /opt/ca/crl

    RequestHeader set SSL_CLIENT_S_DN_CN ""
    RequestHeader set SSL_CLIENT_CERT ""

    <Location /registrar/sessions>
        SSLVerifyClient require
        RequestHeader set SSL-CLIENT-S-DN-CN "%{SSL_CLIENT_S_DN_CN}s"
        RequestHeader set SSL-CLIENT-CERT "%{SSL_CLIENT_CERT}s"
    </Location>
    
    <Location /registrar/id>
        SSLVerifyClient require
        Options Indexes FollowSymLinks MultiViews
        SSLVerifyDepth 2
        SSLOptions +StdEnvVars +ExportCertData
    </Location>
    <Location /api>
        Require all granted
    </Location>

    ProxyPreserveHost on
    ProxyPass / http://registry:3000/
    ProxyPassReverse / http://registry:3000/
</VirtualHost>